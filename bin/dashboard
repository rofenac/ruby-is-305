#!/usr/bin/env bash

# PatchPilot Dashboard Launcher
# Starts both the Ruby API server and the React frontend

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

echo "üöÄ Starting PatchPilot Dashboard..."
echo ""

# Check if node_modules exists
if [ ! -d "$PROJECT_DIR/web-gui/node_modules" ]; then
  echo "üì¶ Installing frontend dependencies..."
  cd "$PROJECT_DIR/web-gui"
  npm install
fi

# Function to cleanup on exit
cleanup() {
  echo ""
  echo "üõë Shutting down..."
  kill $API_PID 2>/dev/null || true
  kill $FRONTEND_PID 2>/dev/null || true
  exit 0
}

trap cleanup SIGINT SIGTERM

# Load environment variables from .env file
if [ -f "$PROJECT_DIR/.env" ]; then
  echo "üîë Loading environment variables from .env..."
  export $(grep -v '^#' "$PROJECT_DIR/.env" | xargs)
else
  echo "‚ö†Ô∏è  Warning: No .env file found. Credentials may not be available."
  echo "   Copy .env.example to .env and configure your credentials."
fi

# Start the Ruby API server
echo "üîß Starting API server on http://0.0.0.0:4567..."
cd "$PROJECT_DIR"
bundle exec ruby api/server.rb &
API_PID=$!

# Wait a moment for API to start
sleep 2

# Start the Vite dev server
echo "üé® Starting frontend on http://0.0.0.0:5173..."
cd "$PROJECT_DIR/web-gui"
npm run dev &
FRONTEND_PID=$!

echo ""
echo "‚úÖ Dashboard is running!"
echo ""
echo "   Frontend: http://0.0.0.0:5173"
echo "   API:      http://0.0.0.0:4567"
echo ""
echo "Press Ctrl+C to stop both servers."
echo ""

# Wait for either process to exit
wait
